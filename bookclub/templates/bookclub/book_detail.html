{% extends 'bookclub/base.html' %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        {% if book.cover_image_url %}
        <img src="{{ book.cover_image_url }}" class="img-fluid book-detail-image" alt="{{ book.title }}">
        {% endif %}

        <!-- User Progress Indicator -->
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">Your Progress</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 24px;">
                    <div class="progress-bar" role="progressbar"
                        style="width: {{ user_progress.normalized_progress }}%;"
                        aria-valuenow="{{ user_progress.normalized_progress }}" aria-valuemin="0" aria-valuemax="100">
                        {{ user_progress.normalized_progress|floatformat:1 }}%
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        {% if user_progress.progress_type == 'page' %}
                        Page {{ user_progress.progress_value }}
                        {% elif user_progress.progress_type == 'audio' %}
                        Audio: {{ user_progress.progress_value }}
                        {% else %}
                        {{ user_progress.progress_value }}% complete
                        {% endif %}
                    </div>

                    <button class="btn btn-sm btn-outline-primary" id="updateProgressBtn">
                        Update Progress
                    </button>
                </div>

                {% if user_progress.hardcover_finished_at %}
                <div class="badge bg-success w-100 p-2 mt-2">Finished</div>
                {% elif user_progress.hardcover_started_at %}
                <div class="badge bg-primary w-100 p-2 mt-2">In Progress</div>
                {% endif %}
            </div>
        </div>

        <div class="d-grid gap-2 mt-3">
            <a href="#" class="btn btn-info" id="syncHardcoverProgress">Sync Hardcover Progress</a>
        </div>
    </div>
    <div class="col-md-9">
        <h1>{{ book.title }}</h1>
        <h4 class="text-muted">{{ book.author }}</h4>
        <p>{{ book.description }}</p>
        <div class="d-flex gap-2">
            <a href="{% url 'group_detail' book.group.id %}" class="btn btn-secondary">Back to Group</a>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h3>Add Comment</h3>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="mb-3">
                {{ form.text.label_tag }}
                {{ form.text }}
            </div>

            <!-- Progress is automatically attached from user's progress data -->
            <input type="hidden" name="progress_type" id="comment_progress_type"
                value="{{ user_progress.progress_type }}">
            <input type="hidden" name="progress_value" id="comment_progress_value"
                value="{{ user_progress.progress_value }}">

            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Discussion</h2>

    <div class="form-check form-switch me-3">
        <input class="form-check-input" type="checkbox" id="showSpoilersToggle" checked>
        <label class="form-check-label" for="showSpoilersToggle">Show all comments</label>
    </div>

    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
            Sort by:
            {% if current_sort == 'date_desc' %}Newest First
            {% elif current_sort == 'date_asc' %}Oldest First
            {% elif current_sort == 'progress_desc' %}Most Progress First
            {% elif current_sort == 'progress_asc' %}Least Progress First
            {% endif %}
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
            <li><a class="dropdown-item {% if current_sort == 'date_desc' %}active{% endif %}"
                    href="?sort=date_desc">Newest First</a></li>
            <li><a class="dropdown-item {% if current_sort == 'date_asc' %}active{% endif %}"
                    href="?sort=date_asc">Oldest First</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item {% if current_sort == 'progress_desc' %}active{% endif %}"
                    href="?sort=progress_desc">Most Progress First</a></li>
            <li><a class="dropdown-item {% if current_sort == 'progress_asc' %}active{% endif %}"
                    href="?sort=progress_asc">Least Progress First</a></li>
        </ul>
    </div>
</div>

{% for comment in comments %}
{% with comment_progress_value=comment.normalized_progress|default:0 %}
<div class="card mb-3 comment-card {% if comment_progress_value > user_progress.normalized_progress and comment.user != user %}spoiler-comment{% endif %}"
    data-progress="{{ comment_progress_value }}">
    <div class="card-header d-flex justify-content-between">
        <span class="comment-user">{{ comment.user.username }}</span>
        <span class="comment-date">{{ comment.created_at|date:"F j, Y, g:i a" }}</span>
    </div>
    <div class="card-body">
        <p class="comment-progress">
            {% if comment.progress_type == 'page' %}
            Page {{ comment.progress_value }}
            {% elif comment.progress_type == 'audio' %}
            Audio: {{ comment.progress_value }}
            {% else %}
            {{ comment.progress_value }}% complete
            {% endif %}

            {% if comment.hardcover_finished_at %}
            <span class="badge bg-success ms-2">Finished</span>
            {% elif comment.hardcover_started_at %}
            <span class="badge bg-primary ms-2">In Progress</span>
            {% endif %}

            {% if comment.hardcover_percent %}
            <span class="text-muted ms-2">({{ comment.hardcover_percent|floatformat:1 }}%)</span>
            {% endif %}

            {% if comment_progress_value > user_progress.normalized_progress and comment.user != user %}
            <span class="badge bg-warning text-dark ms-2">Ahead of your progress</span>
            {% endif %}
        </p>

        {% if comment_progress_value > user_progress.normalized_progress and comment.user != user %}
        <div class="spoiler-warning alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill"></i> This comment is from further in the book than you've read.
            <button class="btn btn-sm btn-outline-secondary ms-2 show-spoiler-btn">Show Anyway</button>
        </div>
        <div class="spoiler-content" style="display: none;">
            <p class="card-text">{{ comment.text }}</p>
        </div>
        {% else %}
        <p class="card-text">{{ comment.text }}</p>
        {% endif %}
    </div>
</div>
{% endwith %}
{% empty %}
<p>No comments yet. Be the first to start the discussion!</p>
{% endfor %}

<!-- Progress Update Modal -->
<div class="modal fade" id="progressUpdateModal" tabindex="-1" aria-labelledby="progressUpdateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressUpdateModalLabel">Update Your Reading Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="progressUpdateForm">
                    <div class="mb-3">
                        <label for="progressType" class="form-label">Progress Type</label>
                        <select class="form-select" id="progressType">
                            <option value="page" {% if user_progress.progress_type == 'page' %}selected{% endif %}>Page
                                Number</option>
                            <option value="audio" {% if user_progress.progress_type == 'audio' %}selected{% endif %}>Audio
                                Timestamp</option>
                            <option value="percent" {% if user_progress.progress_type == 'percent' %}selected{% endif %}>
                                Percentage</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="progressValue" class="form-label">Progress Value</label>
                        <input type="text" class="form-control" id="progressValue"
                            value="{{ user_progress.progress_value }}">
                        <div class="form-text" id="progressHelp">
                            {% if user_progress.progress_type == 'page' %}
                            Enter the page number you're currently on.
                            {% elif user_progress.progress_type == 'audio' %}
                            Enter the timestamp (e.g., "2h 30m").
                            {% else %}
                            Enter a percentage (e.g., "75").
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProgressBtn">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Hardcover Sync Modal -->
<div class="modal fade" id="hardcoverSyncModal" tabindex="-1" aria-labelledby="hardcoverSyncModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hardcoverSyncModalLabel">Sync Progress from Hardcover</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="hardcoverSyncModalBody">
                <p>Fetching your reading progress from Hardcover...</p>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyProgressBtn" disabled>Apply Progress</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const syncButton = document.getElementById('syncHardcoverProgress');
        const updateProgressBtn = document.getElementById('updateProgressBtn');
        const saveProgressBtn = document.getElementById('saveProgressBtn');
        const applyButton = document.getElementById('applyProgressBtn');
        const modalBody = document.getElementById('hardcoverSyncModalBody');
        let hardcoverModal;
        let progressModal;
        let selectedProgress = null;

        // Progress update modal
        updateProgressBtn.addEventListener('click', function () {
            if (!progressModal) {
                progressModal = new bootstrap.Modal(document.getElementById('progressUpdateModal'));
            }
            progressModal.show();
        });

        // Update help text based on progress type selection
        document.getElementById('progressType').addEventListener('change', function () {
            const helpText = document.getElementById('progressHelp');
            const selectedType = this.value;

            if (selectedType === 'page') {
                helpText.textContent = 'Enter the page number you\'re currently on.';
            } else if (selectedType === 'audio') {
                helpText.textContent = 'Enter the timestamp (e.g., "2h 30m").';
            } else {
                helpText.textContent = 'Enter a percentage (e.g., "75").';
            }
        });

        // Save progress button
        saveProgressBtn.addEventListener('click', function () {
            const progressType = document.getElementById('progressType').value;
            const progressValue = document.getElementById('progressValue').value;

            // Send update to server
            fetch('/books/{{ book.id }}/update-progress/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    progress_type: progressType,
                    progress_value: progressValue
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the progress display without page reload
                        document.querySelector('.progress-bar').style.width = data.progress.normalized_progress + '%';
                        document.querySelector('.progress-bar').textContent = parseFloat(data.progress.normalized_progress).toFixed(1) + '%';
                        document.querySelector('.progress-bar').setAttribute('aria-valuenow', data.progress.normalized_progress);

                        // Update the progress text
                        let progressText = '';
                        if (progressType === 'page') {
                            progressText = 'Page ' + progressValue;
                        } else if (progressType === 'audio') {
                            progressText = 'Audio: ' + progressValue;
                        } else {
                            progressText = progressValue + '% complete';
                        }
                        document.querySelector('.card-body .d-flex div').textContent = progressText;

                        // Update the hidden field for comments
                        document.getElementById('comment_progress_type').value = progressType;
                        document.getElementById('comment_progress_value').value = progressValue;

                        // Close the modal
                        progressModal.hide();

                        // Refresh spoilers
                        checkSpoilers();
                    } else {
                        alert('Error updating progress: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating progress. Please try again.');
                });
        });

        // Spoiler functionality
        const showSpoilersToggle = document.getElementById('showSpoilersToggle');
        const spoilerBtns = document.querySelectorAll('.show-spoiler-btn');

        // Toggle all spoilers based on checkbox
        showSpoilersToggle.addEventListener('change', function () {
            const spoilerComments = document.querySelectorAll('.spoiler-comment');

            spoilerComments.forEach(comment => {
                if (this.checked) {
                    comment.querySelector('.spoiler-warning').style.display = 'none';
                    comment.querySelector('.spoiler-content').style.display = 'block';
                } else {
                    comment.querySelector('.spoiler-warning').style.display = 'block';
                    comment.querySelector('.spoiler-content').style.display = 'none';
                }
            });
        });

        // Individual spoiler buttons
        spoilerBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const spoilerWarning = this.closest('.spoiler-warning');
                const spoilerContent = spoilerWarning.nextElementSibling;

                spoilerWarning.style.display = 'none';
                spoilerContent.style.display = 'block';
            });
        });

        // Function to check and update spoilers
        function checkSpoilers() {
            const userProgress = parseFloat(document.querySelector('.progress-bar').getAttribute('aria-valuenow'));

            document.querySelectorAll('.comment-card').forEach(comment => {
                const commentProgress = parseFloat(comment.dataset.progress);
                const isUserComment = comment.querySelector('.comment-user').textContent === '{{ user.username }}';

                if (commentProgress > userProgress && !isUserComment) {
                    // This comment is ahead of user's progress
                    comment.classList.add('spoiler-comment');

                    // Make sure the comment has spoiler warning and hidden content
                    if (!comment.querySelector('.spoiler-warning')) {
                        const cardBody = comment.querySelector('.card-body');
                        const commentText = cardBody.querySelector('.card-text');

                        // Create spoiler warning
                        const spoilerWarning = document.createElement('div');
                        spoilerWarning.className = 'spoiler-warning alert alert-warning';
                        spoilerWarning.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> This comment is from further in the book than you\'ve read. <button class="btn btn-sm btn-outline-secondary ms-2 show-spoiler-btn">Show Anyway</button>';

                        // Create spoiler content container
                        const spoilerContent = document.createElement('div');
                        spoilerContent.className = 'spoiler-content';
                        spoilerContent.style.display = 'none';

                        // Move the comment text into the spoiler content
                        spoilerContent.appendChild(commentText.cloneNode(true));
                        commentText.remove();

                        // Add the elements to the card
                        cardBody.appendChild(spoilerWarning);
                        cardBody.appendChild(spoilerContent);

                        // Add event listener to show button
                        spoilerWarning.querySelector('.show-spoiler-btn').addEventListener('click', function () {
                            spoilerWarning.style.display = 'none';
                            spoilerContent.style.display = 'block';
                        });
                    }
                } else {
                    // This comment is not ahead of user's progress
                    comment.classList.remove('spoiler-comment');

                    // If it had spoiler warning, remove it and show content
                    const spoilerWarning = comment.querySelector('.spoiler-warning');
                    const spoilerContent = comment.querySelector('.spoiler-content');

                    if (spoilerWarning && spoilerContent) {
                        const cardBody = comment.querySelector('.card-body');
                        const commentText = spoilerContent.querySelector('.card-text');

                        // Move the comment text back into the card body
                        cardBody.appendChild(commentText);

                        // Remove spoiler elements
                        spoilerWarning.remove();
                        spoilerContent.remove();
                    }
                }
            });
        }

        // Hardcover sync functionality
        syncButton.addEventListener('click', function (e) {
            e.preventDefault();

            // Initialize the modal if not already done
            if (!hardcoverModal) {
                hardcoverModal = new bootstrap.Modal(document.getElementById('hardcoverSyncModal'));
            }

            // Show the modal with loading state
            hardcoverModal.show();

            // Reset the apply button
            applyButton.disabled = true;
            modalBody.innerHTML = `
                <p>Fetching your reading progress from Hardcover...</p>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

            // Fetch reading progress from Hardcover
            fetch("{% url 'get_hardcover_progress' book.hardcover_id %}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch progress data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }

                    if (!data.progress || data.progress.length === 0) {
                        modalBody.innerHTML = `<div class="alert alert-info">No reading progress found for this book on Hardcover.</div>`;
                        return;
                    }

                    // Display the progress options
                    let html = '<p>Select progress to import:</p><div class="list-group">';

                    data.progress.forEach((item, index) => {
                        const status = item.finished_at ? 'Finished' : (item.started_at ? 'In Progress' : 'Not started');
                        const format = item.reading_format === 'audio' ? 'Audiobook' : 'Book';
                        const progress = item.progress || 0;

                        let details = '';
                        if (item.reading_format === 'audio' && item.current_position) {
                            const hours = Math.floor(item.current_position / 3600);
                            const minutes = Math.floor((item.current_position % 3600) / 60);
                            details = `${hours}h ${minutes}m`;

                            if (item.finished_at && item.edition.audio_seconds) {
                                const totalHours = Math.floor(item.edition.audio_seconds / 3600);
                                const totalMinutes = Math.floor((item.edition.audio_seconds % 3600) / 60);
                                details = `${totalHours}h ${totalMinutes}m (Complete)`;
                            }
                        } else if (item.current_page) {
                            details = `Page ${item.current_page}`;

                            if (item.finished_at && item.edition.pages) {
                                details = `Page ${item.edition.pages} (Complete)`;
                            }
                        }

                        html += `
                            <button type="button" class="list-group-item list-group-item-action" data-index="${index}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${format}</strong>
                                        ${details ? `<small class="d-block text-muted">${details}</small>` : ''}
                                    </div>
                                    <span class="badge ${item.finished_at ? 'bg-success' : 'bg-primary'}">${status}</span>
                                </div>
                                <div class="progress mt-2" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${progress}%;" 
                                         aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                        ${progress}%
                                    </div>
                                </div>
                            </button>
                        `;
                    });

                    html += '</div>';
                    modalBody.innerHTML = html;

                    // Store the progress data for later use
                    window.hardcoverProgressData = data.progress;

                    // Add event listeners to the progress options
                    document.querySelectorAll('.list-group-item').forEach(item => {
                        item.addEventListener('click', function () {
                            document.querySelectorAll('.list-group-item').forEach(el => {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');
                            selectedProgress = window.hardcoverProgressData[parseInt(this.dataset.index)];
                            applyButton.disabled = false;
                        });
                    });
                })
                .catch(error => {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        });

        // Handle apply progress button for Hardcover sync
        applyButton.addEventListener('click', function () {
            if (!selectedProgress) return;

            // Prepare the data
            let progressType, progressValue;

            // Set form values based on selected progress
            if (selectedProgress.reading_format === 'audio') {
                // For audiobooks
                progressType = 'audio';
                if (selectedProgress.current_position) {
                    const hours = Math.floor(selectedProgress.current_position / 3600);
                    const minutes = Math.floor((selectedProgress.current_position % 3600) / 60);
                    progressValue = `${hours}h ${minutes}m`;
                } else {
                    progressValue = selectedProgress.progress + '%';
                }
            } else {
                // For books
                if (selectedProgress.finished_at && selectedProgress.edition.pages) {
                    // For finished books, use the total page count
                    progressType = 'page';
                    progressValue = selectedProgress.edition.pages;
                } else if (selectedProgress.current_page) {
                    // For in-progress books with a page number
                    progressType = 'page';
                    progressValue = selectedProgress.current_page;
                } else {
                    // Default to percentage
                    progressType = 'percent';
                    progressValue = selectedProgress.progress;
                }
            }

            // Create a simplified object with the Hardcover data for saving
            const hardcoverData = {
                started_at: selectedProgress.started_at,
                finished_at: selectedProgress.finished_at,
                progress: selectedProgress.progress,
                current_page: selectedProgress.current_page,
                current_position: selectedProgress.current_position,
                reading_format: selectedProgress.reading_format,
                edition_id: selectedProgress.edition.id,
                edition_pages: selectedProgress.edition.pages,
                edition_audio_seconds: selectedProgress.edition.audio_seconds
            };

            // Update progress via API
            fetch('/books/{{ book.id }}/update-progress/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    progress_type: progressType,
                    progress_value: progressValue,
                    hardcover_data: hardcoverData
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the UI without reloading
                        document.querySelector('.progress-bar').style.width = data.progress.normalized_progress + '%';
                        document.querySelector('.progress-bar').textContent = parseFloat(data.progress.normalized_progress).toFixed(1) + '%';
                        document.querySelector('.progress-bar').setAttribute('aria-valuenow', data.progress.normalized_progress);

                        // Update the progress text
                        let progressText = '';
                        if (progressType === 'page') {
                            progressText = 'Page ' + progressValue;
                        } else if (progressType === 'audio') {
                            progressText = 'Audio: ' + progressValue;
                        } else {
                            progressText = progressValue + '% complete';
                        }
                        document.querySelector('.card-body .d-flex div').textContent = progressText;

                        // Update the hidden fields for comments
                        document.getElementById('comment_progress_type').value = progressType;
                        document.getElementById('comment_progress_value').value = progressValue;

                        // Add status badge if needed
                        const cardBody = document.querySelector('.card-body');
                        if (selectedProgress.finished_at && !cardBody.querySelector('.badge.bg-success')) {
                            // Remove in progress badge if it exists
                            const inProgressBadge = cardBody.querySelector('.badge.bg-primary');
                            if (inProgressBadge) inProgressBadge.remove();

                            // Add finished badge
                            const finishedBadge = document.createElement('div');
                            finishedBadge.className = 'badge bg-success w-100 p-2 mt-2';
                            finishedBadge.textContent = 'Finished';
                            cardBody.appendChild(finishedBadge);
                        } else if (selectedProgress.started_at && !cardBody.querySelector('.badge.bg-primary') && !cardBody.querySelector('.badge.bg-success')) {
                            // Add in progress badge
                            const inProgressBadge = document.createElement('div');
                            inProgressBadge.className = 'badge bg-primary w-100 p-2 mt-2';
                            inProgressBadge.textContent = 'In Progress';
                            cardBody.appendChild(inProgressBadge);
                        }

                        // Close the modal
                        hardcoverModal.hide();

                        // Refresh spoilers
                        checkSpoilers();
                    } else {
                        alert('Error updating progress: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating progress. Please try again.');
                });
        });
    });
</script>
{% endblock %}