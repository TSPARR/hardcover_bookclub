{% extends 'bookclub/base.html' %}
{% load static %}
{% load bookclub_extras %}
{% block title %}{{ book.title }}{% endblock %}
{% block extrahead %}
<meta name="book-pages" content="{{ book_pages|default:'' }}">
<meta name="book-audio-seconds" content="{{ book_audio_seconds|default:'' }}">
<meta name="edition-pages" content="{{ edition_pages|default:'' }}">
<meta name="edition-audio-seconds" content="{{ edition_audio_seconds|default:'' }}">
<meta name="kavita-edition-pages" content="{{ kavita_promoted_edition.pages|default:'' }}">
<meta name="plex-edition-audio-seconds" content="{{ plex_promoted_edition.audio_seconds|default:'' }}">
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3">
            {% include "bookclub/includes/book_detail/book_cover_section.html" %}
            {% include "bookclub/includes/book_detail/book_progress_accordion.html" %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        {% include "bookclub/includes/book_detail/book_header_section.html" %}

        <!-- Group Members' Progress -->
        {% include "bookclub/includes/book_detail/group_member_progress.html" %}

        <!-- Discussion Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Discussion</h3>
                
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showSpoilersToggle" checked>
                        <label class="form-check-label" for="showSpoilersToggle">
                            Show all comments
                        </label>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort by:
                            {% if current_sort == 'date_desc' %}Newest First
                            {% elif current_sort == 'date_asc' %}Oldest First
                            {% elif current_sort == 'progress_desc' %}Most Progress First
                            {% elif current_sort == 'progress_asc' %}Least Progress First
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item {% if current_sort == 'date_desc' %}active{% endif %}"
                                   href="?sort=date_desc">Newest First</a></li>
                            <li><a class="dropdown-item {% if current_sort == 'date_asc' %}active{% endif %}"
                                   href="?sort=date_asc">Oldest First</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item {% if current_sort == 'progress_desc' %}active{% endif %}"
                                   href="?sort=progress_desc">Most Progress First</a></li>
                            <li><a class="dropdown-item {% if current_sort == 'progress_asc' %}active{% endif %}"
                                   href="?sort=progress_asc">Least Progress First</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% include "bookclub/includes/book_detail/comment_form.html" %}

                <!-- Comments List -->
                {% for comment in comments %}
                    {% include "bookclub/includes/book_detail/comment.html" with comment=comment user=user user_progress=user_progress reaction_choices=reaction_choices %}
                {% empty %}
                    <p>No comments yet. Be the first to start the discussion!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
<!-- Progress Update Modal, Hardcover Sync Modal, and other existing modals -->
{% include "bookclub/includes/book_detail/progress_update_modal.html" %}
{% include "bookclub/includes/book_detail/hardcover_sync_modal.html" %}
<!-- Hidden fields for JavaScript -->
<input type="hidden" id="book-id" value="{{ book.id }}">
<input type="hidden" id="hardcover-id" value="{{ book.hardcover_id }}">
<input type="hidden" id="current-username" value="{{ user.username }}">
{% endblock %}
{% block extra_js %}
<script type="module" src="{% static 'bookclub/js/book-detail/main.js' %}"></script>
{% endblock %}